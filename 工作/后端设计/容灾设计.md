# 容灾设计

## 低频写入服务

### 主备容灾

- 同机房新增一个备服务
- 在主不可用的时候，从备服务获取服务

### 同城灾备

- 同城不同机房中分别设置服务
- 诸多服务中，一个为主服务，其他为备服务

### 跨城灾备

- 在不同城市的机房中分别设置服务
- 诸多服务中，一个为主服务，其他为备服务

## 数据服务容灾

### 同城三园区

客户端发起写入数据请求，主收到数据且写入后，还需要等待至少一个备同样写入数据才能返回客户端写入成功。在这种情况下，就能保证即便是主故障，一定能在主之外有一个备有一份最新的数据

由于灾备保障范围仅仅局限在同城，一旦整座城市的机房都不可用，那么业务服务必然不可用

适用场景：

- 可用性要求一般，无跨城容灾诉求
- 业务量级小
- 一致性要求高

### 三地五中心

主城市部署一主一备，一备城市部署一主一备，另外一备城市部署一备

为了保证除了主城市外至少还有一份完整数据，所以主服务写入成功后需要等待两备同样写入数据才能返回客户端写入成功

由于每次数据写入必须要等待至少一个非同城服务确认，所以写入效率很低，写入耗时较长

适用场景：

- 可用性要求高，必须要有跨城容灾
- 数据写入效率要求低，可以容忍较长时间的写入耗时
- 一致性要求高

### 三园区跨城异步容灾

针对高频写入且对歇宿耗时敏感的业务，可以将主服务设置成写入成功后只等待一个同城备写入数据，这样能保证即便主故障但同城仍有一个备保存全部最新数据，而异城服务使用异步的方式同步数据。这种架构在主城市全部故障后不能保证备城市保存了全部最新数据

适用场景

- 高频写，低频读
- 数据一致性要求弱
- 写效率要求高，故障时不能接受短时间内的不可写，机房和城市级故障后必须可写
- 可接受故障时的旧数据暂时不可读

### 强一致性跨城异步容灾

可以降低部分可用性来保证服务的强一致性

除了主备城市以外，增加一个独立城市来存储独立日志。主服务写入数据后将写入日志发送给独立日志存储系统，独立日志存储系统写入成功后主服务便可返回成功

独立日志存储系统相当于分布式系统中的 WAL，即便主备之间网络通信不通，主服务仍可以将日志数据发送给独立日志存储系统

备服务在同步数据完成前，会拒绝为客户提供服务。当主故障时，备需要从独立日志系统拉取全部数据并重放完成后对外提供服务

适用场景

- 高频写
- 一致性要求极高，不能有任何差错
- 写入效率要求极高，写入耗时容忍度低
- 可用性要求接受度一般

### 强一致性高可用跨城异步容灾

基于分片技术，将核心数据拆分成多个子账户来实现高一致性、高可用性和水平扩展能力

每个分片数据部署在三个不同城市，单城市故障时自动切换流量，分片数据间无强依赖

分片内，有一主两备服务，写入请求需多数节点确认