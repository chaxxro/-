# 批处理优化

大量数据导入时有两种方式：

1. 一次执行单个命令，多次执行导入
2. 批量执行多条命令

一次命令的响应时间 = 1 次网络往返耗时 + 1 次 redis 执行命令耗时

批量执行多条命令的响应时间 = 1 次网络往返耗时 + n 次 redis 执行命令耗时

## 单机模式下进行批处理

### 原生命令

Redis 提供了很多批量命令，如 `mset`、`hmset`、`sadd`，优势是命令是原子性的，但原生命令功能有限

### pipeline

原生命令虽然可以批处理，但是只能操作部分数据类型，并且不能进行复杂处理

客户端将命令 1、命令 2、命令 3...一起发送到服务器，服务器按顺序执行这些命令，然后将响应 1、响应 2、响应 3...一起返回给客户端，整个过程只有一次网络往返时间（RTT）

pipeline 批量传给 redis 的命令不是原子性的，可能被其他命令插队，不能保证原子性

如果 pipeline 中的某个命令执行出错，它不会影响其他命令的执行。但是，客户端需要检查每个命令的返回结果以确定是否成功

客户端会将 pipeline 中的命令缓存在内存中，直到调用`execute`方法才会一次性发送。因此，如果命令数量非常多，需要注意内存使用

## 集群下批处理

批处理中的所有 key 必须在一个切片机器上，否则会执行失败

- `for` 循环编译所有切片机器，依次执行单个命令
- 客户端依次计算 key 所属切片机器，对切片机器执行 pipeline
- 合理设计 key 使都属于一个切片机器

